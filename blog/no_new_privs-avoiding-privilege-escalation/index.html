<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.81.0" />

  <title>NO_NEW_PRIVS: avoiding privilege escalation &middot; Marcos&#39; Blog</title>

  <meta name="description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements." />

  

<meta itemprop="name" content="NO_NEW_PRIVS: avoiding privilege escalation">
<meta itemprop="description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements."><meta itemprop="datePublished" content="2018-05-22T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-05-22T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="554">
<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NO_NEW_PRIVS: avoiding privilege escalation"/>
<meta name="twitter:description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements."/>


<meta property="og:title" content="NO_NEW_PRIVS: avoiding privilege escalation" />
<meta property="og:description" content="Sample article showcasing basic Markdown syntax and formatting for HTML elements." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2018-05-22T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2018-05-22T00:00:00&#43;00:00" />




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://mpdesouza.com#author",
      "name": "Marcos Paulo de Souza",
      "image": {
        "@type":"ImageObject",
        "url": "https://www.gravatar.com/avatar/11fc78ee518c3894943153a8f2e5cb0d?s=400&d=mp"
      },
      "description": "Software Engineer"
    },
    {
      "@type": "WebSite",
      "@id": "https://mpdesouza.com#website",
      "url": "https://mpdesouza.com",
      "name": "Marcos' Blog",
      "description": "Software Engineer",
      "publisher": {
        "@id": "https://mpdesouza.com#author"
      },
      "inLanguage": "en"
    },
    {
      "@type": "WebPage",
      "@id": "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/#webpage",
      "url": "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/",
      "name": "NO_NEW_PRIVS: avoiding privilege escalation",
      "isPartOf": {
        "@id": "https://mpdesouza.com#website"
      },
      "about": {
         "@id": "https://mpdesouza.com#author"
      },
      "datePublished": "2018-05-22T00:00:00+00:00",
      "dateModified": "2018-05-22T00:00:00+00:00",
      "description": "Sample article showcasing basic Markdown syntax and formatting for HTML elements.",
      "inLanguage": "en",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/#webpage"
      },
      "headline": "NO_NEW_PRIVS: avoiding privilege escalation",
      "datePublished": "2018-05-22T00:00:00+00:00",
      "dateModified": "2018-05-22T00:00:00+00:00",
      "publisher": {
        "@id": "https://mpdesouza.com#author"
      },
      "keywords": [
      ],
      "articleSection": [
      ],
      "inLanguage": "en",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  
<style type="text/css">
  .sidebar {
    background-color: #000000;
  }

  .read-more-link a {
    border-color: #000000;
  }

  .read-more-link a:hover {
    background-color: #000000;
  }

  .pagination li a {
    color: #000000;
    border: 1px solid #000000;
  }

  .pagination li.active a {
    background-color: #000000;
  }

  .pagination li a:hover {
    background-color: #000000;
    opacity: 0.75;
  }

  footer a,
  .content a,
  .related-posts li a:hover {
    color: #000000;
  }
</style>



  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
      <div class="author-image">
        <a href="https://mpdesouza.com">
          <img src="https://www.gravatar.com/avatar/11fc78ee518c3894943153a8f2e5cb0d?s=200&d=mp" class="img-circle img-headshot center" alt="Gravatar">
        </a>
      </div>
      

      <h1>Marcos&#39; Blog</h1>

      
      <p class="lead">Software Engineer</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://mpdesouza.com">Home</a>
        </li>
        <li>
          <a href="/about-me/">About Me</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://www.linkedin.com/in/marcospsouza/" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="https://github.com/marcosps" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="https://twitter.com/omarcossouza" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1 class="title">NO_NEW_PRIVS: avoiding privilege escalation</h1>
  

  <div class="post-date">
    <time datetime="2018-05-22T00:00:00Z">May 22, 2018</time> <span class="readtime">&middot; 3 min read</span>
  </div>

  <div>
  <p>Proposed in <a href="https://lwn.net/Articles/475362">2012</a>, the <a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt"><em>NO_NEW_PRIVS</em></a> flag made possible to any process to avoid privilege escalation when this behavior is not desired. After the flag is set, it persists across <a href="http://man7.org/linux/man-pages/man2/execve.2.html">execve</a>, <a href="http://man7.org/linux/man-pages/man2/clone.2.html">clone</a> and <a href="http://man7.org/linux/man-pages/man2/fork.2.html">fork</a> syscalls, and cannot be cleared. This can help you to avoid exploitation of vulnerable software, since the attacker will be running as an ordinary user.</p>
<p>The <em>NO_NEW_PRIVS</em> flag is already beeng used by some projects that try to make the running environment more secure, specially container engines and sandbox applications. Some examples are <a href="https://www.projectatomic.io/blog/2016/03/no-new-privs-docker">Docker</a>, <a href="https://github.com/projectatomic/bubblewrap">Bullewrap</a>, and <a href="https://github.com/netblue30/firejail">Firejail</a>.</p>
<p>There are cases where privilege escalation is necessary, for example, to execute a small task that can’t be done by an unprivileged user. This can be achieved by creating a new binary, that only do a very specific task, and have the <a href="https://en.wikipedia.org/wiki/Setuid">setuid</a> bit set (which change the current uid by the owner of the binary) or file <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities</a>(which can hold <em>CAP_SYS_ADMIN</em> for example, and so the current uid becomes practically root).</p>
<p>Another important note for <em>NO_NEW_PRIVS</em> is, after this flag is set, an unprivileged process can install <a href="https://www.kernel.org/doc/Documentation/prctl/seccomp_filter.txt">seccomp_filters</a>.</p>
<p>As described by the official kernel documentation about <em>NO_NEW_PRIVS</em>, this flag is set by using <a href="http://man7.org/linux/man-pages/man2/prctl.2.html">prctl</a>, as exemplified below:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">prctl<span style="color:#ff79c6">(</span>PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0<span style="color:#ff79c6">)</span>;
</code></pre></td></tr></table>
</div>
</div><p>Let’s check how this works. First, we create a new binary called <em>caller</em>, which will be responsible for executing another binary, simply called <em>getuid</em>. The second binary will just print the current <a href="https://en.wikipedia.org/wiki/User_identifier#Effective_user_ID">effective user</a>. Let’s take a look in both binaries, starting from <em>caller</em>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;string.h&gt;</span><span style="color:#ff79c6">
</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;sys/prctl.h&gt;</span><span style="color:#ff79c6">
</span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span><span style="color:#ff79c6"></span>
<span style="color:#8be9fd">int</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv)
{
	<span style="color:#ff79c6">if</span> (argc <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">3</span>)
		errx(<span style="color:#bd93f9">0</span>, <span style="color:#f1fa8c">&#34;Usage: %s &lt;0|1&gt; &lt;path to binary&gt;&#34;</span>, argv[<span style="color:#bd93f9">0</span>]);
	<span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>strncmp(argv[<span style="color:#bd93f9">1</span>], <span style="color:#f1fa8c">&#34;1&#34;</span>, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">&amp;&amp;</span>
	    prctl(PR_SET_NO_NEW_PRIVS, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>)
		errx(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;no_new_privs failed&#34;</span>);

	execlp(argv[<span style="color:#bd93f9">2</span>], argv[<span style="color:#bd93f9">2</span>], <span style="color:#8be9fd;font-style:italic">NULL</span>);
	err(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;execlp&#34;</span>);
}
</code></pre></td></tr></table>
</div>
</div><p>The first binary, <em>caller</em>, will receive two parameters, the first one specifies if the user wants to set the <em>NO_NEW_PRIVS</em> flag, and the second one receives a path to the binary we want to execute. After compiling getuid, we need to change the owner, and turn on the <a href="https://en.wikipedia.org/wiki/Setuid">setuid</a> bit of the resulting binary:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ gcc getuid.c -o getuid
$ sudo chown root:root getuid
$ sudo chmod +s getuid
</code></pre></td></tr></table>
</div>
</div><p>Now, let’s make use of both binaries. Let’s assume you have them in the same directory. First, without setting <em>NO_NEW_PRIVS</em>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./caller <span style="color:#bd93f9">0</span> ./getuid
euid: <span style="color:#bd93f9">0</span>
</code></pre></td></tr></table>
</div>
</div><p>As expected, the printed effective user id is 0, meaning that we are root, thanks to the setuid bit being set and the owner of the binary being root. What happens when we turn on the <em>NO_NEW_PRIVS</em> flag in <em>caller</em>?</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ./caller <span style="color:#bd93f9">1</span> ./getuid
euid: <span style="color:#bd93f9">1000</span>
</code></pre></td></tr></table>
</div>
</div><p>As expected, the effective user id is the one who executes <em>caller</em>, so, no privileges were escalated.</p>
<p>We can also exemplify this behavior using <a href="http://man7.org/linux/man-pages/man1/setpriv.1.html">setpriv</a>, which is part of <a href="https://en.wikipedia.org/wiki/Util-linux">util-linux</a>, to test the <em>NO_NEW_PRIVS</em> flag. Take a look below:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ setpriv ./getuid 
euid: <span style="color:#bd93f9">0</span>
$ setpriv --no-new-privs ./getuid 
euid: <span style="color:#bd93f9">1000</span>
</code></pre></td></tr></table>
</div>
</div><p>As you can see, the output is the same from the <em>caller</em>, as it uses the same feature to avoid privilege escalation.</p>
<p>So, the general suggestion is: always set <em>NO_NEW_PRIVS</em> whenever you don’t need “new privileges” to be added to your process.</p>
<p>See you next time!</p>

  </div>

  


  <div class="share-buttons">
  <a class="twitter-share-button"
     href="#"
     title="Share on Twitter"
     data-url="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
     data-text="NO_NEW_PRIVS: avoiding privilege escalation"><i class="fab fa-twitter"></i></a>

  <a class="linkedin-share-button"
     href="#"
     title="Share on LinkedIn"
     data-url="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
     data-text="NO_NEW_PRIVS: avoiding privilege escalation"><i class="fab fa-linkedin-in"></i></a>

  <a class="facebook-share-button"
     href="#"
     title="Share on Facebook"
     data-url="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
     data-text="NO_NEW_PRIVS: avoiding privilege escalation"><i class="fab fa-facebook"></i></a>

  <a class="telegram-share-button"
     href="#"
     title="Share on Telegram"
     data-url="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
     data-text="NO_NEW_PRIVS: avoiding privilege escalation"><i class="fab fa-telegram"></i></a>

  <a class="pinterest-share-button"
     href="#"
     title="Share on Pinterest"
     data-url="https://mpdesouza.com/blog/no_new_privs-avoiding-privilege-escalation/"
     data-text="NO_NEW_PRIVS: avoiding privilege escalation"><i class="fab fa-pinterest"></i></a>
</div>


  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Marcos Paulo de Souza 2021

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114151448-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
