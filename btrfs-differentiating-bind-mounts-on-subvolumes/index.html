<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://mpdesouza.com/images/favicon.ico" />
<title>btrfs: Differentiating bind mounts on subvolumes | Marcos&#39; Blog</title>
<meta name="title" content="btrfs: Differentiating bind mounts on subvolumes" />
<meta name="description" content="Explaining how to differentiate bind mounts on btrfs subvolumes" />
<meta name="keywords" content="linux,btrfs,bind,mount,subvolume," />


<meta property="og:title" content="btrfs: Differentiating bind mounts on subvolumes" />
<meta property="og:description" content="Explaining how to differentiate bind mounts on btrfs subvolumes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/btrfs-differentiating-bind-mounts-on-subvolumes/" />
<meta property="article:published_time" content="2021-02-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-02-16T00:00:00+00:00" /><meta property="og:site_name" content="Marcos&#39; Blog" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="btrfs: Differentiating bind mounts on subvolumes"/>
<meta name="twitter:description" content="Explaining how to differentiate bind mounts on btrfs subvolumes"/>



<meta itemprop="name" content="btrfs: Differentiating bind mounts on subvolumes">
<meta itemprop="description" content="Explaining how to differentiate bind mounts on btrfs subvolumes">
<meta itemprop="datePublished" content="2021-02-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-02-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="1046">



<meta itemprop="keywords" content="linux,btrfs,bind,mount,subvolume," />

<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  body {
    font-family: Verdana, sans-serif;
    margin: auto;
    padding: 20px;
    max-width: 720px;
    text-align: left;
    background-color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: #444;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  strong,
  b {
    color: #222;
  }

  a {
    color: #3273dc;
     
  }

  .title {
    text-decoration: none;
    border: 0;
  }

  .title span {
    font-weight: 400;
  }

  nav a {
    margin-right: 10px;
  }

  textarea {
    width: 100%;
    font-size: 16px;
  }

  input {
    font-size: 16px;
  }

  content {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  img {
    max-width: 100%;
  }

  code {
    padding: 2px 5px;
    background-color: #f2f2f2;
  }

  pre code {
    color: #222;
    display: block;
    padding: 20px;
    white-space: pre-wrap;
    font-size: 14px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: #222;
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px;
    text-align: center;
  }

  .helptext {
    color: #777;
    font-size: small;
  }

  .errorlist {
    color: #eba613;
    font-size: small;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: #8b6fcb;
  }

  @media (prefers-color-scheme: dark) {
    body {
      background-color: #333;
      color: #ddd;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    strong,
    b {
      color: #eee;
    }

    a {
      color: #8cc2dd;
    }

    code {
      background-color: #777;
    }

    pre code {
      color: #ddd;
    }

    blockquote {
      color: #ccc;
    }

    textarea,
    input {
      background-color: #252525;
      color: #ddd;
    }

    .helptext {
      color: #aaa;
    }
  }

</style>

</head>

<body>
  <header><a href="/" class="title">
  <h2>Marcos&#39; Blog</h2>
</a>
<nav><a href="/">Home</a>


<a href="/blog">Blog</a>

</nav>
</header>
  <main>

<h1>btrfs: Differentiating bind mounts on subvolumes</h1>
<p>
  <i>
    <time datetime='2021-02-16' pubdate>
      16 Feb, 2021
    </time>
  </i>
</p>

<content>
  <p>The <em>btrfs inspect-internal logical-resolve</em> command is used to find a file related to a logical-address. This can be useful when btrfs reports a corruption at an specific logical address, making it easy for the user to find the corrupted file. But, for all current users of openSUSE/SUSE Enterprise Linux, this command was failing as shown below:</p>
<pre><code>btrfs inspect-internal logical-resolve 5085913088 / 
ERROR: cannot access '//@/home': No such file or directory 
</code></pre><p>An openSUSE/SLE intallation would create a set of subvolumes, starting from <em>/@</em>. These subvolumes are mounted on <em>/</em>, but <em>@</em> is never mounted. For example, subvolume <em>/@/home</em> is mounted at <em>/home</em>. We can confirm this behavior by looking at the subvolume list:</p>
<pre><code>$ btrfs subvolume list /
ID 256 gen 32 top level 5 path @
ID 257 gen 416148 top level 256 path @/var
ID 258 gen 416148 top level 256 path @/usr/local
ID 259 gen 416148 top level 256 path @/tmp
ID 260 gen 405918 top level 256 path @/srv
ID 261 gen 362296 top level 256 path @/root
ID 262 gen 371476 top level 256 path @/opt
ID 263 gen 416148 top level 256 path @/home
ID 264 gen 131967 top level 256 path @/boot/grub2/x86_64-efi
ID 265 gen 28 top level 256 path @/boot/grub2/i386-pc
ID 266 gen 354001 top level 256 path @/.snapshots
ID 267 gen 416148 top level 266 path @/.snapshots/1/snapshot
ID 274 gen 53 top level 266 path @/.snapshots/2/snapshot
ID 280 gen 2186 top level 266 path @/.snapshots/7/snapshot
...
</code></pre><p>By checking the fstab file we can verify that all subvolumes are mounted at /, but starting from the subvolume &lsquo;@':</p>
<pre><code>$ cat /etc/fstab
...
UUID=35b19e1f-efb2-49a5-ab93-03c04e6d0399  /opt                    btrfs  subvol=/@/opt                 0  0
UUID=35b19e1f-efb2-49a5-ab93-03c04e6d0399  /home                   btrfs  subvol=/@/home                0  0
...
</code></pre><p>The code related to <em>logical-address</em> look at the full subvolume path (/@/home) and tries to follow it, but subvolume <em>/@</em> isn&rsquo;t mounted, returning an error. To address it, we need to find the exact mountpoint of the subvolume where the file is mounted, and show the path starting from it.</p>
<p>These two patches (<a href="https://github.com/kdave/btrfs-progs/commit/57cfe29e69369be1fd1cfe149ee3cecf37a91968">patch 1</a>, <a href="https://github.com/kdave/btrfs-progs/commit/6b8fed9e798dbcad196e06384b03691ad6512fba">path 2</a>) fixes the issue: finding the correct mountpoint of a subvolume and using it to show the path to the file related to the logical-address.</p>
<p>In this post I&rsquo;ll discuss about the first patch: how to reliably find the correct mountpoint related to a subvolume and a subvolume id.</p>
<h3 id="searching-for-mounted-subvolumes">Searching for mounted subvolumes</h3>
<p>As btrfs mount options always show subvolume and subvolume id, it would be simple as:</p>
<pre><code>$ cat /proc/mounts | grep btrfs | grep &quot;subvolid=5,subvol=/&quot;
/storage/btrfs/1.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=5,subvol=/)
</code></pre><p>The command above searches in the <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">/proc/mounts</a> file which contain all mountpoints, source, target, filesystem type and filesystem options used to mount.</p>
<p>In this case, it works as expect, but what if we have a bind mount mounting from a directory <em>within</em> the current mountpoint? Look at the example below:</p>
<pre><code># create a new disk, format it, create a subvolume and a directory on it
$ fallocate -l5G test.disk

$ mkfs.btrfs -f test.disk

$ mount test.disk /mnt

$ btrfs subvolume create /mnt/vol1
Create subvolume '/mnt/vol1'

$ mount -o subvol=vol1 /mnt
$ mkdir /mnt/dir1

$ cat /proc/mounts | grep btrfs | grep &quot;subvolid=256,subvol=/vol1&quot;
/storage/btrfs/test.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1)

$ umount /mnt

# bind mount it
$ mkdir another_mnt
$ mount -o subvol=vol1 /mnt
$ mount --bind /mnt/dir1 another_mnt
</code></pre><p>Now, if we run the same command as before, we have a problem:</p>
<pre><code>$ cat /proc/mounts | grep btrfs | grep &quot;subvolid=256,subvol=/vol1&quot;
/storage/btrfs/test.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1)
/storage/btrfs/test.disk on /storage/btrfs/another_mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1)
</code></pre><p>As shown, the subvolid and subvol fields are the same, but the content isn&rsquo;t:</p>
<pre><code>$ ls /mnt
dir1
$ ls /storage/btrfs/another_mnt
$
</code></pre><p>Prior to kernel 5.9-rc1, btrfs would show a diferent <em>subvol=</em> option when a bind mount was used. The issue was fixed by this <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3ef3959b29c4a5bd65526ab310a1a18ae533172a">patch</a>. Before this change the <em>/proc/mounts</em> file would differentiate bind mounts:</p>
<pre><code>/dev/sda /mnt/test btrfs rw,relatime,subvolid=256,subvol=/foo 0 0
/dev/sda /mnt/test/baz btrfs rw,relatime,subvolid=256,subvol=/foo/bar 0 0
</code></pre><p>This was wrong, since the subvolume shown should be the same for a bind mount. The patch above fixed the behavior, and now a bind mount will show the same subvol and subvolid fields on a mountpoint:</p>
<pre><code>/dev/sda /mnt/test btrfs rw,relatime,subvolid=256,subvol=/foo 0 0
/dev/sda /mnt/test/baz btrfs rw,relatime,subvolid=256,subvol=/foo 0 0
</code></pre><p>As <em>/proc/mounts</em> can&rsquo;t be used to differentiate bind mounts, how can we proceed?</p>
<h3 id="using-procpidmountinfo">Using /proc/&lt;pid&gt;/mountinfo</h3>
<p>There is a different proc file that shows all mountpoints, accessible by <em>/proc/&lt;pid&gt;/mountinfo</em>. The <em>&lt;pid&gt;</em> comes form the fact that the process can be in a different <a href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html">mount namespace</a>. By using the <em>pid</em> the kernel knows which mountpoints are visible to the process. You can also use <em>self</em> if you want the mountpoints of the current process namespace.</p>
<p>The description of all mountinfo fields, along with the /proc/mounts one, can be see in the <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">procfs manpage</a>.</p>
<p>What does <strong>mountinfo</strong> shows in this setup?</p>
<pre><code>cat /proc/self/mountinfo | grep btrfs | grep &quot;subvolid=256,subvol=/vol1&quot;
37 28 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1
36 29 0:31 /vol1/dir1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1
</code></pre><p>By looking at the forth field, we can see an interesting info. The manpage describes this field as:</p>
<blockquote>
<p>root: the pathname of the directory in the filesystem which forms the root of this mount.</p>
</blockquote>
<p>The mountinfo proc file can show the path <em>within</em> the filesystem used at the mount time. In this case, we just need to check if the forth field contains the same subvolume path specified in the filesystem options.</p>
<p>What if we create a bind mount using the same directory of the original mount?</p>
<pre><code>$ umount another_mnt
$ mount --bind /mnt/ another_mnt
$ cat /proc/self/mountinfo | grep btrfs | grep &quot;subvolid=256,subvol=/vol1&quot;
37 28 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1
36 29 0:31 /vol1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1
</code></pre><p>As we can see, both mount roots are the same since both mountpoints have the same contents. The bind mount is just another way of accessing the same content of /mnt.</p>
<p>I used this approach in this <a href="https://git.kernel.org/pub/scm/linux/kernel/git/kdave/btrfs-progs.git/commit/?id=57cfe29e69369be1fd1cfe149ee3cecf37a91968">patch</a> in order to solve one of the <em>logical-resolve</em> issues when running the comannd on a openSUSE/SLE distribution. Now the command runs correctly and reports the file related to a logical-address in the filesystem:</p>
<pre><code>btrfs inspect-internal logical-resolve 5085913088 /
//./home/marcos/.local/share/flatpak/repo/objects/00/7e3655177d55a02ca39d4cd3d095627f824b8004ad70f416eccb8bdd281fd5.file
</code></pre><p>The patch was merged and is already part of btrfs-progs v5.10.1 along with other important fixes.</p>
<p>Thanks for reading!</p>

</content>
<p>
  
  <a href="https://mpdesouza.com/blog/linux/">#linux</a>
  
  <a href="https://mpdesouza.com/blog/btrfs/">#btrfs</a>
  
  <a href="https://mpdesouza.com/blog/bind/">#bind</a>
  
  <a href="https://mpdesouza.com/blog/mount/">#mount</a>
  
  <a href="https://mpdesouza.com/blog/subvolume/">#subvolume</a>
  
</p>

  </main>
  <footer>Made with <a href="https://github.com/janraasch/hugo-bearblog/">Hugo ʕ•ᴥ•ʔ Bear</a>
</footer>

    
</body>

</html>
